name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/deploy*.yml'
      - '.github/workflows/release.yml'
  pull_request:
    branches: [main, develop]

# Prevent multiple CI runs for same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx6g -XX:MaxMetaspaceSize=1g" -Dorg.gradle.daemon=false -Dorg.gradle.parallel=false'

jobs:
  # Job 1: Unit Tests - Fast feedback across all platforms
  unit-tests:
    name: Unit Tests (Java ${{ matrix.java }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        java: [21]
        include:
          - os: ubuntu-latest
            java: 17

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew (Unix)
        if: runner.os != 'Windows'
        run: chmod +x gradlew

      - name: Run unit tests
        run: ./gradlew :src:cli:test --no-daemon

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: unit-test-results-${{ matrix.os }}-java${{ matrix.java }}
          path: |
            src/cli/build/test-results/test/**/*.xml
            src/cli/build/reports/tests/test/**
          retention-days: 7

  # Job 2: Integration & E2E Tests - Linux only (all test batches)
  integration-tests:
    name: Integration & E2E Tests - Linux
    runs-on: ubuntu-latest
    needs: [unit-tests]
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up JDK 21
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: 21
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run integration tests batch 1 (command tests)
        run: ./gradlew :src:cli:integrationTests1 -PforceTests=true -PrunIntegrationTests=true --no-daemon --stacktrace
        env:
          DROPPER_TEST_ENV: linux
          RUNNER_TEMP: ${{ runner.temp }}

      - name: Run integration tests batch 2
        run: ./gradlew :src:cli:integrationTests2 -PforceTests=true -PrunIntegrationTests=true --no-daemon --stacktrace
        env:
          DROPPER_TEST_ENV: linux
          RUNNER_TEMP: ${{ runner.temp }}

      - name: Run integration tests batch 3
        run: ./gradlew :src:cli:integrationTests3 -PforceTests=true -PrunIntegrationTests=true --no-daemon --stacktrace
        env:
          DROPPER_TEST_ENV: linux
          RUNNER_TEMP: ${{ runner.temp }}

      - name: Run E2E tests
        run: ./gradlew :src:cli:e2eTests -PforceTests=true -PrunIntegrationTests=true --no-daemon --stacktrace
        env:
          DROPPER_TEST_ENV: linux
          RUNNER_TEMP: ${{ runner.temp }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: integration-test-results
          path: |
            src/cli/build/test-results/**/*.xml
            src/cli/build/reports/tests/**
          retention-days: 7

      - name: Upload HTML reports on failure
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: integration-test-html-reports
          path: src/cli/build/reports/tests/**/*.html
          retention-days: 30

  # Job 3: Build CLI Distribution
  build-cli:
    name: Build CLI (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [unit-tests]
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up JDK 21
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: 21
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew (Unix)
        if: runner.os != 'Windows'
        run: chmod +x gradlew

      - name: Build CLI distribution
        run: ./gradlew :src:cli:distZip --no-daemon

      - name: Upload distribution
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: dropper-cli-${{ matrix.os }}
          path: src/cli/build/distributions/*.zip
          retention-days: 30

  # Job 4: Code Quality Checks
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: 21
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Compile Kotlin code
        run: ./gradlew :src:cli:compileKotlin --no-daemon

      - name: Run Kotlin linter (if configured)
        run: ./gradlew :src:cli:detekt --no-daemon --continue || true

  # Job 5: Test Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, build-cli, code-quality]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Download test results
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          pattern: '*-test-results*'
          path: test-results
          merge-multiple: true

      - name: Publish test summary
        uses: test-summary/action@032c8a9cec6aaa3c20228112cae6ca10a3b29336 # v2.4
        if: always()
        with:
          paths: 'test-results/**/*.xml'
          show: 'all'

      - name: Check overall success
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.unit-tests.result }}" == "success" ]; then
            echo "✅ Unit tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Unit tests failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "✅ Integration & E2E tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Integration & E2E tests failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build-cli.result }}" == "success" ]; then
            echo "✅ CLI build passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ CLI build failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "✅ Code quality checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Code quality checks failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if any job failed
        if: |
          needs.unit-tests.result == 'failure' ||
          needs.integration-tests.result == 'failure' ||
          needs.build-cli.result == 'failure' ||
          needs.code-quality.result == 'failure'
        run: exit 1
