name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/deploy*.yml'
      - '.github/workflows/release.yml'
  pull_request:
    branches: [main, develop]

# Prevent multiple CI runs for same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m -XX:MaxMetaspaceSize=512m" -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true'

jobs:
  # Job 1: Code Quality Checks
  code-quality:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up JDK 21
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: 21
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check Kotlin code style
        run: ./gradlew :src:cli:detekt --continue || true

      - name: Run dependency vulnerability check
        run: ./gradlew :src:cli:dependencyCheckAnalyze --continue || true

      - name: Verify no compilation warnings
        run: |
          ./gradlew :src:cli:compileKotlin -Pwarnings-as-errors=false 2>&1 | tee compile.log
          echo "Compilation completed"

  # Job 2: Unit Tests
  unit-tests:
    name: Unit Tests (Java ${{ matrix.java }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        java: [21]
        include:
          # Test with Java 17 on Ubuntu for backwards compatibility
          - os: ubuntu-latest
            java: 17

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew (Unix)
        if: runner.os != 'Windows'
        run: chmod +x gradlew

      - name: Stop existing Gradle daemons
        run: ./gradlew --stop

      - name: Run unit tests (ValidationUtil)
        run: ./gradlew :src:cli:test --tests "dev.dropper.util.ValidationUtilTest" --rerun-tasks
        continue-on-error: true

      - name: Run unit tests (PackageNameSanitization)
        run: ./gradlew :src:cli:test --tests "dev.dropper.util.PackageNameSanitizationTest" --rerun-tasks
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: unit-test-results-${{ matrix.os }}-java${{ matrix.java }}
          path: |
            src/cli/build/test-results/test/**/*.xml
            src/cli/build/reports/tests/test/**
          retention-days: 7

  # Job 3: E2E Tests - Package Sanitization
  e2e-package-sanitization:
    name: E2E - Package Sanitization (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up JDK 21
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: 21
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew (Unix)
        if: runner.os != 'Windows'
        run: chmod +x gradlew

      - name: Stop existing Gradle daemons
        run: ./gradlew --stop

      - name: Build CLI
        run: ./gradlew :src:cli:assemble

      - name: Run package sanitization verification script (Unix)
        if: runner.os != 'Windows'
        run: |
          chmod +x scripts/verify-package-sanitization.sh
          ./scripts/verify-package-sanitization.sh
        continue-on-error: true

      - name: Run package sanitization verification script (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          ./scripts/verify-package-sanitization.ps1
        continue-on-error: true

      - name: Run E2E package name generation tests
        run: ./gradlew :src:cli:test --tests "dev.dropper.e2e.PackageNameGenerationE2ETest" --rerun-tasks
        continue-on-error: true

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: e2e-package-test-results-${{ matrix.os }}
          path: |
            src/cli/build/test-results/test/**/*.xml
            src/cli/build/reports/tests/test/**
          retention-days: 7

  # Job 4: E2E Tests - Template Validation
  e2e-template-validation:
    name: E2E - Template Validation (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up JDK 21
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: 21
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew (Unix)
        if: runner.os != 'Windows'
        run: chmod +x gradlew

      - name: Stop existing Gradle daemons
        run: ./gradlew --stop

      - name: Build CLI
        run: ./gradlew :src:cli:assemble

      - name: Run template validation tests
        run: ./gradlew :src:cli:test --tests "dev.dropper.e2e.TemplateValidationE2ETest" --rerun-tasks
        continue-on-error: true

      - name: Upload template test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: e2e-template-test-results-${{ matrix.os }}
          path: |
            src/cli/build/test-results/test/**/*.xml
            src/cli/build/reports/tests/test/**
          retention-days: 7

  # Job 5: E2E Tests - Complex Modpack
  e2e-complex-modpack:
    name: E2E - Complex Modpack (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up JDK 21
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: 21
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Stop existing Gradle daemons
        run: ./gradlew --stop

      - name: Build CLI
        run: ./gradlew :src:cli:assemble

      - name: Run complex modpack tests
        run: ./gradlew :src:cli:test --tests "dev.dropper.e2e.ComplexModpackE2ETest" --rerun-tasks
        continue-on-error: true

      - name: Upload complex modpack test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: e2e-complex-modpack-test-results-${{ matrix.os }}
          path: |
            src/cli/build/test-results/test/**/*.xml
            src/cli/build/reports/tests/test/**
          retention-days: 7

  # Job 6: Build Distribution
  build-distribution:
    name: Build Distribution (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [code-quality, unit-tests]
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up JDK 21
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: 21
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew (Unix)
        if: runner.os != 'Windows'
        run: chmod +x gradlew

      - name: Build distribution
        run: ./gradlew :src:cli:distZip

      - name: Upload distribution artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: dropper-cli-${{ matrix.os }}
          path: src/cli/build/distributions/*.zip
          retention-days: 30

  # Job 7: Integration Test - Generated Project Build
  integration-test-generated-project:
    name: Integration - Generated Project Build
    runs-on: ubuntu-latest
    needs: [build-distribution]
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up JDK 21
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: 21
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build CLI
        run: ./gradlew :src:cli:assemble

      - name: Generate test project with special characters
        run: |
          mkdir -p build/integration-test
          cd build/integration-test
          ../../gradlew :src:cli:run --args="init my_test-mod --name 'My Test Mod' --id my_test-mod --author Test --description 'Test project' --versions 1.20.1 --loaders fabric"

      - name: Generate items in test project
        run: |
          cd build/integration-test/my_test-mod
          ../../../gradlew :src:cli:run --args="item test_sword"
          ../../../gradlew :src:cli:run --args="item magic_wand"

      - name: Generate blocks in test project
        run: |
          cd build/integration-test/my_test-mod
          ../../../gradlew :src:cli:run --args="block test_ore"

      - name: Verify package structure
        run: |
          cd build/integration-test/my_test-mod

          # Check sanitized package exists
          if [ ! -d "shared/common/src/main/java/com/mytestmod" ]; then
            echo "ERROR: Sanitized package directory not found"
            exit 1
          fi

          # Check Services.java has correct package
          if ! grep -q "package com.mytestmod;" "shared/common/src/main/java/com/mytestmod/Services.java"; then
            echo "ERROR: Services.java has incorrect package"
            exit 1
          fi

          # Check item has correct package
          if ! grep -q "package com.mytestmod.items;" "shared/common/src/main/java/com/mytestmod/items/TestSword.java"; then
            echo "ERROR: TestSword has incorrect package"
            exit 1
          fi

          echo "âœ“ All package structure checks passed"

      - name: Upload generated project
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: generated-test-project
          path: build/integration-test/my_test-mod/**
          retention-days: 7

  # Job 8: Test Result Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, e2e-package-sanitization, e2e-template-validation, e2e-complex-modpack, integration-test-generated-project]
    if: always()
    timeout-minutes: 10

    steps:
      - name: Download all test results
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          pattern: '*-test-results-*'
          path: test-results
          merge-multiple: true

      - name: Publish test summary
        uses: test-summary/action@032c8a9cec6aaa3c20228112cae6ca10a3b29336 # v2.4
        if: always()
        with:
          paths: 'test-results/**/*.xml'
          show: 'all'

      - name: Check test success
        run: |
          echo "All test jobs completed"
          echo "Check individual job results for details"
