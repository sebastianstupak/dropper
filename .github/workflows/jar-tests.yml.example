name: JAR Output E2E Tests

on:
  # Run weekly on Sunday at midnight UTC
  schedule:
    - cron: '0 0 * * 0'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'Test scope (all, fabric, forge, neoforge)'
        required: false
        default: 'fabric'
        type: choice
        options:
          - all
          - fabric
          - forge
          - neoforge

  # Run on PR to main if JAR test files changed
  pull_request:
    branches: [main]
    paths:
      - 'src/cli/src/test/**/JarOutputE2ETest.kt'
      - 'src/cli/src/test/**/JarValidationUtilsTest.kt'
      - 'src/cli/src/main/resources/buildSrc/**'

jobs:
  # Quick validation tests (run on every PR)
  validation:
    name: JAR Validation Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Run validation tests
        run: ./gradlew :src:cli:test --tests "JarValidationUtilsTest"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-test-results
          path: src/cli/build/reports/tests/
          retention-days: 7

  # Full JAR build tests (Fabric only - automated)
  fabric-jars:
    name: Fabric JAR Tests
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3
        with:
          cache-read-only: false

      - name: Cache Minecraft dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches/fabric-loom
            ~/.gradle/caches/minecraft
          key: ${{ runner.os }}-minecraft-${{ hashFiles('**/buildSrc/**/*.kt') }}
          restore-keys: |
            ${{ runner.os }}-minecraft-

      - name: Run Fabric JAR tests (Unix)
        if: runner.os != 'Windows'
        run: |
          export RUN_JAR_TESTS=true
          ./gradlew :src:cli:test --tests "JarOutputE2ETest.Fabric*" --stacktrace

      - name: Run Fabric JAR tests (Windows)
        if: runner.os == 'Windows'
        run: |
          $env:RUN_JAR_TESTS="true"
          .\gradlew.bat :src:cli:test --tests "JarOutputE2ETest.Fabric*" --stacktrace

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fabric-jar-test-results-${{ matrix.os }}
          path: |
            src/cli/build/reports/tests/
            src/cli/build/test-results/
          retention-days: 30

      - name: Upload built JARs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fabric-jars-${{ matrix.os }}
          path: |
            build/test-jar-output/**/build/**/*.jar
          retention-days: 7

  # All loaders (requires manual configuration - optional)
  all-loaders:
    name: All Loaders JAR Tests
    runs-on: ubuntu-latest
    timeout-minutes: 120
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.test_scope == 'all'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3

      - name: Cache Minecraft dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches/fabric-loom
            ~/.gradle/caches/minecraft
            ~/.gradle/caches/forge
            ~/.gradle/caches/neoforge
          key: ${{ runner.os }}-all-loaders-${{ hashFiles('**/buildSrc/**/*.kt') }}
          restore-keys: |
            ${{ runner.os }}-all-loaders-

      - name: Run all JAR tests
        run: |
          export RUN_JAR_TESTS=true
          ./gradlew :src:cli:test --tests "JarOutputE2ETest" --stacktrace
        continue-on-error: true  # Forge/NeoForge may need manual setup

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: all-loaders-test-results
          path: |
            src/cli/build/reports/tests/
            src/cli/build/test-results/
          retention-days: 30

      - name: Upload built JARs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: all-loaders-jars
          path: |
            build/test-jar-output/**/build/**/*.jar
          retention-days: 7

  # Performance benchmarking
  performance:
    name: JAR Build Performance
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3

      - name: Run performance test
        run: |
          export RUN_JAR_TESTS=true
          ./gradlew :src:cli:test \
            --tests "JarOutputE2ETest.*completes in reasonable time" \
            --stacktrace

      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: src/cli/build/reports/tests/
          retention-days: 90

  # Summary job
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [validation, fabric-jars]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate summary
        run: |
          echo "# JAR Output Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY

          if [ -d "validation-test-results" ]; then
            echo "✅ Validation tests completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Validation tests failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "fabric-jar-test-results-ubuntu-latest" ]; then
            echo "✅ Fabric JAR tests (Linux) completed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "fabric-jar-test-results-windows-latest" ]; then
            echo "✅ Fabric JAR tests (Windows) completed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "fabric-jar-test-results-macos-latest" ]; then
            echo "✅ Fabric JAR tests (macOS) completed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Built JARs" >> $GITHUB_STEP_SUMMARY

          # Count JARs
          jar_count=$(find . -name "*.jar" 2>/dev/null | wc -l)
          echo "Total JARs built: $jar_count" >> $GITHUB_STEP_SUMMARY

          # List JARs
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### JAR Files" >> $GITHUB_STEP_SUMMARY
          find . -name "*.jar" -exec bash -c 'echo "- $(basename {}): $(du -h {} | cut -f1)"' \; >> $GITHUB_STEP_SUMMARY || true

      - name: Check for failures
        if: |
          needs.validation.result == 'failure' ||
          needs.fabric-jars.result == 'failure'
        run: exit 1
