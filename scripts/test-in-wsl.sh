#!/bin/bash

#
# Run Dropper CLI tests in WSL (Windows Subsystem for Linux)
# This bypasses Windows Gradle test executor issues by running in a Linux environment
#

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘           Dropper CLI - WSL Test Runner                      â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check if running in WSL
if grep -qi microsoft /proc/version 2>/dev/null; then
    echo "âœ… Running in WSL"
    IN_WSL=true
else
    echo "âš ï¸  Not running in WSL - will attempt to launch WSL"
    IN_WSL=false
fi

echo ""

# Get the project directory (convert Windows path to WSL path if needed)
if [ "$IN_WSL" = true ]; then
    # Already in WSL, use current directory
    PROJECT_DIR="$(pwd)"
else
    # Not in WSL, need to convert path and run in WSL
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

    echo "Launching WSL from Windows..."
    echo "Project: $PROJECT_DIR"
    echo ""

    # Convert Windows path to WSL path (e.g., D:\foo -> /mnt/d/foo)
    WSL_PATH=$(echo "$PROJECT_DIR" | sed 's|^\([A-Za-z]\):|/mnt/\L\1|' | sed 's|\\|/|g')

    exec wsl bash -c "cd '$WSL_PATH' && bash scripts/test-in-wsl.sh"
fi

# Now we're definitely in WSL
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Environment Check"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "ğŸ“ Project Directory: $PROJECT_DIR"
echo "ğŸ§ Distribution: $(lsb_release -d | cut -f2)"
echo "â˜• Java Version:"
java -version 2>&1 | head -n 3
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Running Full Test Suite"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Run tests with test filtering disabled (all tests enabled)
# Set environment variable to indicate we're in WSL
export DROPPER_TEST_ENV=wsl

echo "Running: ./gradlew :src:cli:test --no-daemon"
echo ""

if ./gradlew :src:cli:test --no-daemon; then
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘              âœ… ALL TESTS PASSED IN WSL! âœ…                   â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    # Show test summary
    echo "Test Summary:"
    echo "  âœ“ All unit tests"
    echo "  âœ“ All integration tests"
    echo "  âœ“ All E2E tests"
    echo "  âœ“ All command tests"
    echo ""
    exit 0
else
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘              âŒ SOME TESTS FAILED âŒ                          â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "Check the test output above for details."
    echo ""
    exit 1
fi
